import { StandardButton, HorizontalBox } from "std-widgets.slint";
import { Theme } from "../theme.slint";
import { CInput } from "../widgets/CInput.slint";
import { Icons } from "../icons.slint";
import { CButton } from "../widgets/CButton.slint";
import { CSelect } from "../widgets/CSelect.slint";
import { GState } from "../const.slint";

export component NewConnectionDialog inherits Dialog {
    always-on-top: true;
    
    // Propiedades exportadas para acceso desde el componente padre
    in-out property <string> connection_name;
    in-out property <string> database_type;
    in-out property <string> db_host;
    in-out property <string> db_port;
    in-out property <string> db_name;
    in-out property <string> db_user;
    in-out property <string> db_password;
    callback close-dialog();
    callback testConnection();
    callback addConnection();
    Rectangle {
        background: Theme.background;
        border-color: Theme.text;
        border-radius: Theme.border-radius;
        border-width: Theme.border-width;
        VerticalLayout {
            padding: Theme.padding;
            HorizontalLayout {
                spacing: Theme.spacing;
                Image {
                    width: 30px;
                    height: 30px;
                    source: Icons.database;
                    colorize: Theme.text;
                    vertical-alignment: center;
                }

                Text {
                    text: "New Database Connection";
                    font-size: 18pt;
                    color: Theme.text;
                    vertical-alignment: center;
                }

                CButton {
                    height: 40px;
                    icon: Icons.close;
                    onClick => {
                        close-dialog();
                    }
                }
            }

            Rectangle {
                width: 100%;
                height: 1px;
                background: Theme.border-color;
            }

            VerticalLayout {
                spacing: Theme.form-spacing;
                Rectangle {
                    height: 5px;
                }

                CInput {
                    label: "Connection Name";
                    text <=> root.connection_name;
                }

                CSelect {
                    label: "Database Type";
                    model: ["", "MySQL", "PostgreSQL", "SQLite"];
                    selected(value) => {
                        root.database_type = value;
                        GState.db_type = value;
                        debug("Database type: " + value);
                        
                        // Auto-llenar puerto por defecto
                        if (value == "MySQL" && root.db_port == "") {
                            root.db_port = "3306";
                        } else if (value == "PostgreSQL" && root.db_port == "") {
                            root.db_port = "5432";
                        } else if (value == "SQLite") {
                            root.db_port = "";
                        }
                    }
                }

                HorizontalLayout {
                    width: 100%;
                    CInput {
                        label: "Host";
                        width: 48.5%;
                        text <=> root.db_host;
                    }

                    Rectangle {
                        width: 10px; // Spacer
                    }

                    CInput {
                        label: "Port";
                        width: 48.5%;
                        text <=> root.db_port;
                    }
                }

                CInput {
                    label: "Database Name";
                    text <=> root.db_name;
                }

                CInput {
                    label: "User";
                    text <=> root.db_user;
                }

                CInput {
                    label: "Password";
                    text <=> root.db_password;
                }

                // Action buttons
                HorizontalLayout {
                    spacing: Theme.spacing;
                    width: 100%;
                    CButton {
                        height: 40px;
                        width: 50%;
                        icon: Icons.test_connection;
                        background: Theme.gray;
                        text: "Test Connection";
                        hover-color: Theme.green;
                        has-hover-color: true;
                        onClick => {
                            testConnection();
                        }
                    }

                    CButton {
                        height: 40px;
                        width: 50%;
                        icon: Icons.plus_icon;
                        background: Theme.gray;
                        text: "Add Connection";
                        hover-color: Theme.green;
                        has-hover-color: true;
                        onClick => {
                            addConnection();
                            close-dialog();
                        }
                    }
                }
            }
        }
    }
}
