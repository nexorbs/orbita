import { ScrollView } from "std-widgets.slint";
import { Theme } from "../theme.slint";
import { GState } from "../const.slint";
import { Icons } from "../icons.slint";

// Estructuras para la base de datos
struct DatabaseColumn {
    name: string,
    type: string,
    nullable: bool,
    primary-key: bool,
    default-value: string,
}

struct DatabaseTable {
    name: string,
    columns: [DatabaseColumn],
    row-count: int,
}

struct StoredProcedure {
    name: string,
    parameters: [string],
    return-type: string,
}

struct DatabaseConnection {
    name: string,
    connection-string: string,
    tables: [DatabaseTable],
    stored-procedures: [StoredProcedure],
    connected: bool,
}

// Componente para mostrar columnas de tabla
export component ColumnItem {
    in property <DatabaseColumn> column;
    height: 20px;
    Rectangle {
        background: ta.has-hover ? #e8e8e8 : transparent;
        border-radius: 2px;
        HorizontalLayout {
            padding-left: 16px;
            spacing: 8px;
            alignment: start;
            
            // Icono de columna
            Rectangle {
                width: 12px;
                height: 12px;
                background: root.column.primary-key ? #ffd700 : #4a90e2;
                border-radius: 2px;
            }

            Text {
                text: root.column.name;
                font-size: 11px;
                color: #333333;
                vertical-alignment: center;
            }

            Text {
                text: "(" + root.column.type + ")";
                font-size: 10px;
                color: #666666;
                vertical-alignment: center;
            }

            if (root.column.primary-key): Text {
                text: "PK";
                font-size: 9px;
                color: #ff6b35;
                vertical-alignment: center;
            }
        }

        ta := TouchArea { }
    }
}

// Componente para mostrar tablas
component TableItem {
    in property <DatabaseTable> table;
    callback table-selected(string);
    ta := TouchArea {
        ContextMenuArea {
            Rectangle {
                height: 22px;
                background: ta.has-hover ? Theme.button-hover-background : transparent;
                border-radius: 2px;
                HorizontalLayout {
                    padding-left: 8px;
                    spacing: 6px;
                    alignment: start;
                    // Icono de tabla
                    Rectangle {
                        width: 14px;
                        height: 14px;
                        background: Theme.green;
                        border-radius: 2px;
                    }

                    Text {
                        text: root.table.name;
                        font-size: 12px;
                        font-weight: 600;
                        color: Theme.white;
                        vertical-alignment: center;
                    }

                    Text {
                        text: "(" + root.table.row-count + " filas)";
                        font-size: 10px;
                        color: #888888;
                        vertical-alignment: center;
                    }
                }
            }

            Menu {
                MenuItem {
                    title: @tr("Show records");
                    activated => {
                        debug("SELECT * FROM " + root.table.name);
                    }
                }

                MenuItem {
                    title: @tr("Edit table");
                    activated => {
                        debug("Edit table: " + root.table.name);
                    }
                }
            }
        }
    }
}

// Componente para procedimientos almacenados
component StoredProcedureItem {
    in property <StoredProcedure> procedure;
    callback procedure-selected(string);
    height: 20px;
    Rectangle {
        background: ta.has-hover ? #e8f4fd : transparent;
        border-radius: 2px;
        HorizontalLayout {
            padding-left: 8px;
            spacing: 6px;
            alignment: start;
            
            // Icono de procedimiento
            Rectangle {
                width: 12px;
                height: 12px;
                background: #FF9800;
                border-radius: 6px;
            }

            Text {
                text: root.procedure.name;
                font-size: 11px;
                color: #333333;
                vertical-alignment: center;
            }
        }

        ta := TouchArea {
            clicked => {
                root.procedure-selected(root.procedure.name);
            }
        }
    }
}


// Navegador principal de base de datos
export component DatabaseBrowser {
    in-out property <bool> is_db_connected: GState.is_db_connected;
    in-out property <string> ui_db_name;
    in property <DatabaseConnection> database: {
        name: ui_db_name,
        connection-string: "Server=localhost;Database=test;",
        connected: root.is_db_connected,
        tables: [
            {
                name: "usuarios",
                row-count: 150,
                columns: [
                    { name: "id", type: "int", nullable: false, primary-key: true, default-value: "" },
                    {
                        name: "nombre",
                        type: "varchar(100)",
                        nullable: false,
                        primary-key: false,
                        default-value: ""
                    },
                    {
                        name: "email",
                        type: "varchar(255)",
                        nullable: false,
                        primary-key: false,
                        default-value: ""
                    },
                    {
                        name: "fecha_creacion",
                        type: "datetime",
                        nullable: false,
                        primary-key: false,
                        default-value: "GETDATE()"
                    },
                ]
            },
            {
                name: "productos",
                row-count: 89,
                columns: [
                    { name: "id", type: "int", nullable: false, primary-key: true, default-value: "" },
                    {
                        name: "nombre",
                        type: "varchar(200)",
                        nullable: false,
                        primary-key: false,
                        default-value: ""
                    },
                    {
                        name: "precio",
                        type: "decimal(10,2)",
                        nullable: false,
                        primary-key: false,
                        default-value: "0.00"
                    },
                    { name: "stock", type: "int", nullable: false, primary-key: false, default-value: "0" },
                ]
            },
            {
                name: "pedidos",
                row-count: 245,
                columns: [
                    { name: "id", type: "int", nullable: false, primary-key: true, default-value: "" },
                    { name: "usuario_id", type: "int", nullable: false, primary-key: false, default-value: "" },
                    {
                        name: "fecha_pedido",
                        type: "datetime",
                        nullable: false,
                        primary-key: false,
                        default-value: "GETDATE()"
                    },
                    {
                        name: "total",
                        type: "decimal(10,2)",
                        nullable: false,
                        primary-key: false,
                        default-value: "0.00"
                    },
                ]
            }
        ],
        stored-procedures: [
            { name: "sp_obtener_usuarios", parameters: ["@activos bit"], return-type: "table" },
            {
                name: "sp_crear_pedido",
                parameters: ["@usuario_id int", "@total decimal"],
                return-type: "int"
            },
            {
                name: "sp_actualizar_stock",
                parameters: ["@producto_id int", "@cantidad int"],
                return-type: "void"
            },
        ]
    };
    callback item-selected(string, string); // tipo, nombre
    
    VerticalLayout {
        width: 300px;
        height: parent.height;

        // Header - Icono y t铆tulo de bases de datos
        HorizontalLayout {
            alignment: start;
            padding: 8px;
            Image {
                source: Icons.database;
                width: 20px;
                height: 20px;
                colorize: Theme.soft_gray;
            }

            Text {
                text: "DATABASES";
                font-size: 18px;
                color: Theme.soft_gray;
                padding-left: 8px;
            }
        }


        // Informaci贸n de conexi贸n
        VerticalLayout {
            padding: 8px;
            spacing: 4px;
            HorizontalLayout {
                spacing: 8px;
                alignment: space-between;
                
                // Indicador de estado de conexi贸n
                Rectangle {
                    width: 16px;
                    height: 16px;
                    background: root.database.connected ? Theme.green : Theme.gray;
                    border-radius: 8px;
                }
        
                // Nombre de la base de datos
                Text {
                    text: root.database.name;
                    color: root.database.connected ? Theme.green : Theme.gray;
                    font-size: 13px;
                    font-weight: 600;
                    vertical-alignment: center;
                }
            }


            // Tipo de base de datos
            Text {
                text: GState.db_type;
                color: Theme.soft_gray;
                font-size: 11px;
                vertical-alignment: center;
            }
        }


        // Contenido principal con scroll
        ScrollView {
            VerticalLayout {
                padding: 8px;
                spacing: 4px;
                    
                // Secci贸n de Tablas
                Rectangle {
                    height: 25px;
                    background: #f8f9fa;
                    border-radius: 3px;
                    HorizontalLayout {
                        padding-left: 8px;
                        alignment: start;
                        Text {
                            text: " TABLAS (" + root.database.tables.length + ")";
                            font-size: 11px;
                            font-weight: 700;
                            color: #495057;
                            vertical-alignment: center;
                        }
                    }
                }


                // Lista de tablas
                for table in root.database.tables: TableItem {
                    table: table;
                    table-selected(name) => {
                        root.item-selected("table", name);
                    }
                }
                
                // Espaciador
                Rectangle {
                    height: 10px;
                }
                    
                // Secci贸n de Procedimientos Almacenados
                Rectangle {
                    height: 25px;
                    background: #fff3cd;
                    border-radius: 3px;
                    HorizontalLayout {
                        padding-left: 8px;
                        alignment: start;
                        Text {
                            text: "锔 PROCEDIMIENTOS (" + root.database.stored-procedures.length + ")";
                            font-size: 11px;
                            font-weight: 700;
                            color: #856404;
                            vertical-alignment: center;
                        }
                    }
                }


                // Lista de procedimientos almacenados
                for procedure in root.database.stored-procedures: StoredProcedureItem {
                    procedure: procedure;
                    procedure-selected(name) => {
                        root.item-selected("procedure", name);
                    }
                }
            }
        }
    }
}
